name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version consistency
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $psd1Path = "src\Win11ProMinimalist\Win11ProMinimalist.psd1"
          $changelogPath = "CHANGELOG.md"

          if (!(Test-Path $psd1Path)) { throw "Manifest not found." }
          if (!(Test-Path $changelogPath)) { throw "CHANGELOG not found." }

          $manifest = Import-PowerShellDataFile -Path $psd1Path
          $moduleVersion = [string]$manifest.ModuleVersion

          $raw = Get-Content $changelogPath -Raw
          $match = [regex]::Match($raw, '##\s*\[(\d+\.\d+\.\d+)\]')
          if (!$match.Success) { throw "Could not parse top version from CHANGELOG.md" }

          $changelogVersion = $match.Groups[1].Value

          Write-Host "ModuleVersion: $moduleVersion"
          Write-Host "CHANGELOG version: $changelogVersion"

          if ($moduleVersion -ne $changelogVersion) {
            throw "Version mismatch: psd1=$moduleVersion, changelog=$changelogVersion"
          }

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
          $results = Invoke-ScriptAnalyzer -Path "src\Win11ProMinimalist\Win11ProMinimalist.psm1" -Recurse

          $errors = $results | Where-Object Severity -eq "Error"
          if ($errors) {
            $errors | Format-Table
            throw "PSScriptAnalyzer errors detected."
          }

          $warnings = $results | Where-Object Severity -eq "Warning"
          if ($warnings) {
            Write-Host "Warnings detected (not failing build):"
            $warnings | Format-Table
          }
